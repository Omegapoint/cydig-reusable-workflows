name: Create release for github actions

on:
  workflow_call:
    
jobs:
  release:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Install dependencies and build
        run: npm ci && npm run build
      
      - name: "Get latest release tag"
        id: latest_release
        run: |
          current_version=`gh release list --limit 30 | grep Latest | awk '{ print $1;}'`
          if [ -z "$current_version" ]
          then
            echo "No release found"
            echo "Creating tag for firt release"
            echo "version=v1.0.0" >> $GITHUB_ENV
          else
            echo "version=${current_version}" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Display version
        run: |
          # Display the version from the environment
          echo "Latest Version: ${{ env.version }}"
          
      - name: Determine semver bump from PR labels
        id: determine-bump
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "PR_NUMBER=$PR_NUMBER"
          # Gather labels on the pull request (may be empty)
          labels=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name' || true)
          echo "PR labels: $labels"

          match="none"
          # Prefer major > minor > patch
          if echo "$labels" | grep -qw major; then match=major; fi
          if [ "$match" = "none" ] && echo "$labels" | grep -qw minor; then match=minor; fi
          if [ "$match" = "none" ] && echo "$labels" | grep -qw patch; then match=patch; fi

          echo "Determined match: $match"
          echo "match=$match" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump semver (script)
        if: ${{ env.match != 'none' }}
        id: bump
        run: |
          # Read current version (set earlier by the workflow). Fallback to v1.0.0
          cur="${{ env.version }}"
          if [ -z "$cur" ] || [ "$cur" = "No release found" ]; then
            cur="v1.0.0"
          fi
          # Strip leading 'v'
          ver="${cur#v}"
          IFS='.' read -r major minor patch <<< "$ver"

          case "${{ env.match }}" in
            major)
              major=$((major + 1)); minor=0; patch=0
              ;;
            minor)
              minor=$((minor + 1)); patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            *) ;;
          esac

          new_version="v${major}.${minor}.${patch}"
          echo "new_version=${new_version}" >> $GITHUB_ENV
          echo "New version: $new_version"

      - name: Create git tag and push
        if: ${{ env.match != 'none' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create annotated tag and push it
          git tag -a "${{ env.new_version }}" -m "Release ${{ env.new_version }}"
          git push origin "${{ env.new_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release on GitHub
        if: ${{ env.match != 'none' }}
        run: |
          gh release create "${{ env.new_version }}" --title "${{ env.new_version }}" --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
